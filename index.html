<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="origin">
    <title>CINEMA MAX</title>
    <style>
        :root { --bg: #0e0e0e; --panel: #181818; --accent: #e50914; --text: #f5f5f5; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Верхняя панель */
        .header { 
            background: var(--panel); padding: 15px 20px; border-bottom: 1px solid #333; 
            display: flex; gap: 20px; align-items: center; z-index: 100;
        }
        .logo { font-weight: 900; color: var(--accent); font-size: 18px; letter-spacing: 1px; white-space: nowrap; }

        /* Поиск */
        .search-box { position: relative; flex: 1; max-width: 500px; }
        input { 
            width: 100%; background: #000; border: 1px solid #333; color: #fff; 
            padding: 12px 15px; border-radius: 6px; outline: none; font-size: 15px; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--accent); }

        /* Выпадашка результатов */
        .dropdown {
            position: absolute; top: 105%; left: 0; width: 100%; 
            background: #1a1a1a; border: 1px solid #333; border-radius: 6px;
            max-height: 500px; overflow-y: auto; display: none; z-index: 200;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .item { 
            display: flex; gap: 12px; padding: 10px; border-bottom: 1px solid #252525; 
            cursor: pointer; transition: 0.2s;
        }
        .item:hover { background: #333; }
        .poster { width: 40px; height: 60px; object-fit: cover; border-radius: 3px; background: #000; }
        .info { display: flex; flex-direction: column; justify-content: center; }
        .title { font-weight: bold; font-size: 14px; }
        .meta { font-size: 12px; color: #888; }

        /* Панель кнопок (скролл для мобильных) */
        .source-tabs { 
            display: flex; gap: 8px; margin-left: auto; overflow-x: auto; 
            padding-bottom: 5px; max-width: 600px;
        }
        .tab-btn {
            background: #222; border: 1px solid #333; color: #aaa; padding: 8px 14px; 
            cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 13px; white-space: nowrap;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .tab-btn:hover { color: #fff; background: #333; }
        .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        
        /* Стили для статусов кнопок */
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
        .tab-btn.active .dot { background: #fff; box-shadow: 0 0 5px #fff; }

        /* Экран */
        .screen { flex: 1; position: relative; background: #000; width: 100%; height: 100%; }
        
        /* IFRAMES */
        iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; }
        
        .placeholder {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: #444; pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">ALL.CINEMA</div>
        
        <div class="search-box">
            <input type="text" id="query" placeholder="Поиск (TMDB)..." autocomplete="off">
            <div class="dropdown" id="results"></div>
        </div>

        <div class="source-tabs">
            <button class="tab-btn active" onclick="setPlayer('collaps')"><div class="dot"></div> Collaps</button>
            <button class="tab-btn" onclick="setPlayer('flixcdn')"><div class="dot"></div> FlixCDN</button>
            <button class="tab-btn" onclick="setPlayer('kodik')"><div class="dot"></div> Kodik</button>
            <button class="tab-btn" onclick="setPlayer('bazon')"><div class="dot"></div> Bazon</button>
            <button class="tab-btn" onclick="setPlayer('ustore')"><div class="dot"></div> Ustore</button>
        </div>
    </div>

    <div class="screen">
        <div class="placeholder" id="msg">Введите название фильма...</div>

        <iframe id="main-frame" src="" style="display:none;"></iframe>

        <iframe id="flixcdn" src="" style="display:none;"></iframe>
    </div>

    <script src="actualize.js"></script>

    <script>
        const TMDB_KEY = '15d2ea6d0dc1d476efbca3eba2b9bbfb'; 
        
        // Базовые ссылки
        const URLS = {
            collaps: (id) => `https://api.strvid.ws/embed/movie/${id}`,
            kodik: (id) => `https://kodik.info/find-player?imdbID=${id}`,
            bazon: (id) => `https://bazon.cc/embed?imdb=${id}`,
            ustore: (id) => `https://ustore.bz/embed/${id}`,
            // FlixCDN обрабатывается отдельно
            flixcdn_base: 'https://player0.flixcdn.space/show/imdb' 
        };

        let currentImdbId = null;
        let currentMode = 'collaps';
        let debounceTimer;

        const input = document.getElementById('query');
        const dropdown = document.getElementById('results');
        const msg = document.getElementById('msg');
        
        const frameMain = document.getElementById('main-frame');
        const frameFlix = document.getElementById('flixcdn');

        // --- 1. Поиск TMDB ---
        input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const val = input.value.trim();
            if (val.length < 2) { dropdown.style.display = 'none'; return; }
            debounceTimer = setTimeout(() => searchTMDB(val), 400);
        });

        async function searchTMDB(query) {
            dropdown.style.display = 'block';
            dropdown.innerHTML = '<div style="padding:15px;color:#777">Поиск...</div>';

            try {
                const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_KEY}&query=${encodeURIComponent(query)}&language=ru-RU`);
                const data = await res.json();
                
                dropdown.innerHTML = '';
                if (!data.results?.length) { dropdown.innerHTML = '<div style="padding:15px">Ничего не найдено</div>'; return; }

                data.results.forEach(m => {
                    if (!m.poster_path && !m.overview) return;
                    
                    const el = document.createElement('div');
                    el.className = 'item';
                    const poster = m.poster_path ? `https://image.tmdb.org/t/p/w92${m.poster_path}` : '';
                    
                    el.innerHTML = `
                        <img src="${poster}" class="poster" onerror="this.style.opacity=0">
                        <div class="info">
                            <div class="title">${m.title}</div>
                            <div class="meta">${m.release_date?.split('-')[0] || ''} • ${m.vote_average}</div>
                        </div>
                    `;
                    el.onclick = () => loadMovie(m.id);
                    dropdown.appendChild(el);
                });
            } catch (e) { dropdown.innerHTML = '<div style="padding:15px;color:red">Ошибка сети</div>'; }
        }

        // --- 2. Получение ID ---
        async function loadMovie(tmdbId) {
            dropdown.style.display = 'none';
            msg.innerText = "Получение ссылок...";
            
            try {
                // Получаем IMDb ID, так как он универсален для всех плееров
                const res = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_KEY}`);
                const data = await res.json();
                
                if (data.imdb_id) {
                    currentImdbId = data.imdb_id;
                    updatePlayer();
                } else {
                    alert("У фильма нет IMDb ID. Плееры могут не найти его.");
                }
            } catch (e) { console.error(e); }
        }

        // --- 3. Переключение ---
        function setPlayer(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active'); // Ставим active на нажатую кнопку
            
            if (currentImdbId) updatePlayer();
        }

        // --- 4. Обновление плеера ---
        function updatePlayer() {
            msg.style.display = 'none';
            const id = currentImdbId;

            // Сброс
            frameMain.style.display = 'none';
            frameMain.src = "";
            frameFlix.style.display = 'none';
            frameFlix.src = "";

            if (currentMode === 'flixcdn') {
                // FLIXCDN (Особая обработка для скрипта)
                frameFlix.style.display = 'block';
                frameFlix.src = `${URLS.flixcdn_base}/${id}`;
                console.log("Loading FlixCDN:", frameFlix.src);
            } else {
                // Остальные (Collaps, Kodik, Bazon, Ustore)
                frameMain.style.display = 'block';
                const url = URLS[currentMode](id);
                console.log(`Loading ${currentMode}:`, url);
                frameMain.src = url;
            }
        }
    </script>
</body>
</html>
