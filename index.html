<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="origin">
    <title>CINEMA: KINOBD EDITION</title>
    <style>
        :root { --bg: #0e0e0e; --panel: #181818; --accent: #00bcd4; --text: #f5f5f5; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Шапка */
        .header { 
            background: var(--panel); padding: 15px 20px; border-bottom: 1px solid #333; 
            display: flex; gap: 20px; align-items: center; z-index: 100;
        }
        .logo { font-weight: 900; color: var(--accent); font-size: 18px; letter-spacing: 1px; white-space: nowrap; }

        /* Поиск */
        .search-box { position: relative; flex: 1; max-width: 500px; }
        input { 
            width: 100%; background: #000; border: 1px solid #333; color: #fff; 
            padding: 12px 15px; border-radius: 6px; outline: none; font-size: 15px; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--accent); }

        /* Выпадашка результатов */
        .dropdown {
            position: absolute; top: 105%; left: 0; width: 100%; 
            background: #1a1a1a; border: 1px solid #333; border-radius: 6px;
            max-height: 500px; overflow-y: auto; display: none; z-index: 200;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .item { 
            display: flex; gap: 12px; padding: 10px; border-bottom: 1px solid #252525; 
            cursor: pointer; transition: 0.2s;
        }
        .item:hover { background: #333; }
        .poster { width: 40px; height: 60px; object-fit: cover; border-radius: 3px; background: #000; }
        .info { display: flex; flex-direction: column; justify-content: center; }
        .title { font-weight: bold; font-size: 14px; }
        .meta { font-size: 12px; color: #888; }

        /* Панель кнопок */
        .source-tabs { 
            display: flex; gap: 8px; margin-left: auto; overflow-x: auto; 
            padding-bottom: 5px; max-width: 600px;
        }
        .tab-btn {
            background: #222; border: 1px solid #333; color: #aaa; padding: 8px 14px; 
            cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 13px; white-space: nowrap;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .tab-btn:hover { color: #fff; background: #333; }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
        .tab-btn.active .dot { background: #000; box-shadow: 0 0 5px #000; }

        /* Экран */
        .screen { flex: 1; position: relative; background: #000; width: 100%; height: 100%; }
        iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; }
        
        .placeholder {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: #444; pointer-events: none;
        }
        
        .status-msg {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px;
            color: var(--accent); font-size: 12px; pointer-events: none; display: none;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">KINO.BD</div>
        
        <div class="search-box">
            <input type="text" id="query" placeholder="Поиск (TMDB)..." autocomplete="off">
            <div class="dropdown" id="results"></div>
        </div>

        <div class="source-tabs">
            <button class="tab-btn active" onclick="setPlayer('collaps')"><div class="dot"></div> Collaps</button>
            <button class="tab-btn" onclick="setPlayer('kinobd')"><div class="dot"></div> KinoBD</button>
            <button class="tab-btn" onclick="setPlayer('flixcdn')"><div class="dot"></div> FlixCDN</button>
            <button class="tab-btn" onclick="setPlayer('kodik')"><div class="dot"></div> Kodik</button>
            <button class="tab-btn" onclick="setPlayer('bazon')"><div class="dot"></div> Bazon</button>
            <button class="tab-btn" onclick="setPlayer('ustore')"><div class="dot"></div> Ustore</button>
        </div>
    </div>

    <div class="screen">
        <div class="placeholder" id="msg">Введите название фильма...</div>

        <iframe id="main-frame" src="" style="display:none;"></iframe>

        <iframe id="flixcdn" src="" style="display:none;"></iframe>
        
        <div class="status-msg" id="status">Загрузка...</div>
    </div>

    <script src="actualize.js"></script>

    <script>
        const TMDB_KEY = '15d2ea6d0dc1d476efbca3eba2b9bbfb'; 
        
        const URLS = {
            collaps: (id) => `https://api.strvid.ws/embed/movie/${id}`,
            kodik: (id) => `https://kodik.info/find-player?imdbID=${id}`,
            bazon: (id) => `https://bazon.cc/embed?imdb=${id}`,
            ustore: (id) => `https://ustore.bz/embed/${id}`,
            flixcdn_base: 'https://player0.flixcdn.space/show/imdb'
        };

        let currentImdbId = null;
        let currentTitle = null;
        let currentMode = 'collaps';
        let debounceTimer;

        const input = document.getElementById('query');
        const dropdown = document.getElementById('results');
        const msg = document.getElementById('msg');
        const status = document.getElementById('status');
        
        const frameMain = document.getElementById('main-frame');
        const frameFlix = document.getElementById('flixcdn');

        // --- Поиск TMDB ---
        input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const val = input.value.trim();
            if (val.length < 2) { dropdown.style.display = 'none'; return; }
            debounceTimer = setTimeout(() => searchTMDB(val), 400);
        });

        async function searchTMDB(query) {
            dropdown.style.display = 'block';
            dropdown.innerHTML = '<div style="padding:15px;color:#777">Поиск...</div>';

            try {
                const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_KEY}&query=${encodeURIComponent(query)}&language=ru-RU`);
                const data = await res.json();
                
                dropdown.innerHTML = '';
                if (!data.results?.length) { dropdown.innerHTML = '<div style="padding:15px">Ничего не найдено</div>'; return; }

                data.results.forEach(m => {
                    if (!m.poster_path && !m.overview) return;
                    const el = document.createElement('div');
                    el.className = 'item';
                    const poster = m.poster_path ? `https://image.tmdb.org/t/p/w92${m.poster_path}` : '';
                    
                    el.innerHTML = `
                        <img src="${poster}" class="poster" onerror="this.style.opacity=0">
                        <div class="info">
                            <div class="title">${m.title}</div>
                            <div class="meta">${m.release_date?.split('-')[0] || ''} • ${m.vote_average}</div>
                        </div>
                    `;
                    el.onclick = () => loadMovie(m);
                    dropdown.appendChild(el);
                });
            } catch (e) { dropdown.innerHTML = '<div style="padding:15px;color:red">Ошибка сети</div>'; }
        }

        async function loadMovie(movie) {
            dropdown.style.display = 'none';
            msg.innerText = "Получение ссылок...";
            currentTitle = movie.title;
            
            try {
                const res = await fetch(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${TMDB_KEY}`);
                const data = await res.json();
                
                if (data.imdb_id) {
                    currentImdbId = data.imdb_id;
                    updatePlayer();
                } else {
                    alert("Нет IMDb ID.");
                }
            } catch (e) { console.error(e); }
        }

        function setPlayer(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (currentImdbId) updatePlayer();
        }

        async function updatePlayer() {
            msg.style.display = 'none';
            const id = currentImdbId;
            
            // Сброс
            frameMain.style.display = 'none';
            frameFlix.style.display = 'none';
            frameMain.src = "";
            frameFlix.src = "";
            status.style.display = 'none';

            console.log(`Switching to ${currentMode}...`);

            if (currentMode === 'kinobd') {
                // --- KINOBD API INTEGRATION ---
                // Используем их API для поиска по IMDb ID
                status.innerText = "Запрос к API KinoBD...";
                status.style.display = 'block';

                try {
                    // Пробуем найти фильм по IMDb через их API
                    const apiUrl = `https://kinobd.ru/api/films/search/imdb_id?q=${id}`;
                    const res = await fetch(apiUrl);
                    
                    if (!res.ok) throw new Error('CORS or Network Error');
                    
                    const data = await res.json();
                    
                    if (data.data && data.data.length > 0) {
                        // Если API вернуло данные, ищем ссылку на плеер или используем ID для страницы
                        // Так как Swagger не показывает поле iframe, пробуем открыть их страницу плеера
                        // Или предполагаем, что у них есть embed
                        const filmId = data.data[0].id;
                        // Эвристика: пробуем открыть плеер
                        alert(`Найден фильм в базе KinoBD (ID: ${filmId}). Но API не отдает прямой Iframe. Перенаправляем на поиск...`);
                        window.open(`https://kinobd.ru/search?q=${encodeURIComponent(currentTitle)}`, '_blank');
                    } else {
                        alert("KinoBD: Фильм не найден в их базе.");
                    }
                } catch (e) {
                    // Если API заблокировано (CORS), открываем поиск у них на сайте
                    console.error("KinoBD Error:", e);
                    if(confirm("API KinoBD заблокировало запрос (CORS). Открыть поиск на их сайте в новой вкладке?")) {
                        window.open(`https://kinobd.ru/search?q=${encodeURIComponent(currentTitle)}`, '_blank');
                    }
                }
                status.style.display = 'none';

            } else if (currentMode === 'flixcdn') {
                frameFlix.style.display = 'block';
                frameFlix.src = `${URLS.flixcdn_base}/${id}`;
            } else {
                frameMain.style.display = 'block';
                frameMain.src = URLS[currentMode](id);
            }
        }
    </script>
</body>
</html>
